-- 創建 exercise_type_coefficients 表格
CREATE TABLE [exercise_type_coefficients]
(
    [exercise_type_id] INT PRIMARY KEY IDENTITY(1, 1),
    [exercise_name] NVARCHAR(50) NOT NULL,  -- 運動名稱
    [met] FLOAT NOT NULL                    -- MET 值
)
GO

-- 創建 body_metrics 表格
CREATE TABLE [body_metrics]
(
    [id] INT PRIMARY KEY IDENTITY(1, 1),
    [user_id] INT NOT NULL FOREIGN KEY REFERENCES [users](user_id) ON DELETE CASCADE,  -- 外鍵參照 [users] 表格的 user_id
    [weight] FLOAT NOT NULL,                                            -- 體重
    [body_fat] FLOAT,                                                  -- 體脂率
    [muscle_mass] FLOAT,                                                -- 肌肉量
    [waist_circumference] FLOAT,                                        -- 腰圍
    [hip_circumference] FLOAT,                                          -- 臀圍
    [height] FLOAT,                                                     -- 身高
    [bmi] FLOAT,                                                        -- BMI
    [date_recorded] DATETIME2 DEFAULT GETDATE()                          -- 記錄日期，默認為當前日期
)
GO

-- 創建 exercise_records 表格
CREATE TABLE [exercise_records]
(
    [record_id] INT PRIMARY KEY IDENTITY(1, 1),
    [user_id] INT NOT NULL FOREIGN KEY REFERENCES [users](user_id) ON DELETE CASCADE,  -- 外鍵參照 [users] 表格的 user_id
    [exercise_type] NVARCHAR(50) NOT NULL,                                -- 運動類型
    [exercise_duration] INT NOT NULL,                                     -- 運動時長（分鐘）
    [calories_burned] FLOAT NOT NULL,                                     -- 消耗的卡路里
    [exercise_date] DATE NOT NULL                                         -- 運動日期
)
GO

-- 創建 nutrition_records 表格
CREATE TABLE [nutrition_records]
(
    [record_id] INT PRIMARY KEY IDENTITY(1, 1),
    [user_id] INT FOREIGN KEY REFERENCES [users](user_id) ON DELETE CASCADE,  -- 外鍵參照 [users] 表格的 user_id
    [food_name] NVARCHAR(255) NOT NULL,                                    -- 食物名稱
    [calories] INT NOT NULL,                                               -- 食物卡路里
    [protein] FLOAT NOT NULL,                                              -- 蛋白質含量
    [carbs] FLOAT NOT NULL,                                                -- 碳水化合物含量
    [fats] FLOAT NOT NULL,                                                 -- 脂肪含量
    [mealtime] NVARCHAR(50) CHECK (mealtime IN ('早餐', '午餐', '晚餐', '點心')),  -- 餐點時間（早餐、午餐、晚餐、點心）
    [record_date] DATETIME2 DEFAULT GETDATE()                              -- 記錄日期，默認為當前日期
)
GO

-- 創建 fitness_goals 表格
CREATE TABLE [fitness_goals]
(
    [goal_id] INT PRIMARY KEY IDENTITY(1, 1),                            -- 目標 ID
    [user_id] INT NOT NULL FOREIGN KEY REFERENCES [users](user_id) ON DELETE CASCADE, -- 外鍵參照 [users] 表格的 user_id
    [goal_type] NVARCHAR(50) NOT NULL CHECK (goal_type IN ('減重', '增肌', '心肺健康', '其他')),  -- 目標類型
    [target_value] FLOAT NOT NULL,                                        -- 目標值（例如：減少 5 公斤）
    [current_progress] FLOAT DEFAULT 0,                                   -- 當前進度
    [unit] NVARCHAR(20) CHECK (unit IN ('公斤', '百分比', '分鐘', '卡路里')), -- 單位（公斤、百分比、分鐘、卡路里）
    [start_date] DATETIME2 DEFAULT GETDATE(),                             -- 開始日期，默認為當前日期
    [end_date] DATETIME2 NULL,                                            -- 結束日期（可為 NULL）
    [status] NVARCHAR(20) CHECK (status IN ('進行中', '已完成', '未達成')) DEFAULT '進行中', -- 目標狀態
    CONSTRAINT [CK_EndDate] CHECK ([end_date] IS NULL OR [end_date] >= [start_date])  -- 結束日期檢查（結束日期不可早於開始日期）
)
GO

-- 創建 achievements 表格
CREATE TABLE [achievements]
(
    [achievement_id] INT PRIMARY KEY IDENTITY(1, 1),
    [user_id] INT NOT NULL FOREIGN KEY REFERENCES [users](user_id) ON DELETE CASCADE,  -- 外鍵參照 [users] 表格的 user_id
    [achievement_type] NVARCHAR(50) CHECK (achievement_type IN ('目標達成', '一般成就')),  -- 獎勳類型
    [title] NVARCHAR(255) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL,  -- 獎勳標題
    [description] NVARCHAR(500),                                          -- 獎勳描述
    [achieved_date] DATE DEFAULT GETDATE(),                               -- 獲得日期，默認為當前日期
    CONSTRAINT [UC_UniqueAchievement] UNIQUE ([user_id], [title])         -- 獎勳標題唯一
)
GO

-- 創建 DashboardStats 視圖
CREATE VIEW [DashboardStats] AS
SELECT 
    (SELECT COUNT(*) FROM [users] WHERE [role] = 'user') AS TotalUsers,                  -- 總用戶數
    (SELECT COUNT(*) FROM [exercise_records]) AS TotalWorkouts,                        -- 總運動紀錄數
    (SELECT SUM([exercise_duration]) FROM [exercise_records]) AS TotalWorkoutMinutes,    -- 總運動時長（分鐘）
    (SELECT SUM([calories_burned]) FROM [exercise_records]) AS TotalCaloriesBurned,      -- 總消耗卡路里
    (SELECT COUNT(DISTINCT [user_id]) FROM [exercise_records] WHERE DATEDIFF(DAY, [exercise_date], GETDATE()) <= 7 AND [user_id] IS NOT NULL) AS ActiveUsersThisWeek;  -- 本週活躍用戶數
GO
